{% extends "base.html" %}

{% block title %}Bot Steuerung | Dashboard{% endblock %}

{% block content %}
<style>
    .dashboard-container { padding: 2.5rem; }
    .card { height: 100%; transition: all 0.2s ease; border: 1px solid var(--border-muted); }
    .card:hover { transform: translateY(-3px); background-color: var(--card-hover); border-color: rgba(59, 130, 246, 0.2); }
    .status-badge { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    .btn-action-sm { padding: 0.6rem 1rem; font-size: 0.8rem; font-weight: 700; border-radius: 8px; border: none; text-transform: uppercase; }
    .btn-settings-big { background-color: var(--blue-deep); color: white; border: none; font-weight: 600; border-radius: 8px; padding: 0.75rem 1rem; transition: all 0.2s; text-align: center; text-decoration: none; display: block; width: 100%; font-size: 0.9rem; }
    .btn-settings-big:hover { background-color: #2563eb; color: white; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
    .btn-settings-outline { background: transparent; color: var(--text-secondary); border: 1px solid var(--border-muted); font-weight: 600; border-radius: 8px; padding: 0.75rem 1rem; transition: all 0.2s; text-align: center; text-decoration: none; display: block; width: 100%; font-size: 0.9rem; }
    .btn-settings-outline:hover { background: rgba(255, 255, 255, 0.05); color: #fff; border-color: var(--blue-accent); }
    .action-header { border-bottom: 1px solid var(--border-muted); margin-bottom: 2rem; padding-bottom: 1.5rem; }
    .btn-logout { background: rgba(239, 68, 68, 0.1); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); font-weight: 600; }
    .btn-logout:hover { background: #ef4444; color: white; }
    
    /* Update Card Styles */
    .update-card { background: linear-gradient(145deg, #1e293b, #0f172a); border: 1px solid #3b82f644; margin-top: 3rem; }
    .version-tag { background: #3b82f622; color: #60a5fa; padding: 2px 8px; border-radius: 6px; font-family: monospace; font-size: 0.85rem; border: 1px solid #3b82f633; }
    #updateChangelog { background: #00000044; padding: 15px; border-radius: 8px; font-size: 0.9rem; color: #94a3b8; line-height: 1.6; white-space: pre-wrap; }
</style>

<div class="dashboard-container">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="fw-bold mb-1 h3 text-white">Bot <span class="text-blue">Steuerung</span></h1>
            <p class="text-secondary small">Zentrale Verwaltung aller Bot-Systeme</p>
        </div>
        <div>
            <span class="text-secondary me-3 small"><i class="bi bi-person-circle"></i> {{ session.get('user') }}</span>
            <a href="{{ url_for('logout') }}" class="btn btn-logout btn-sm px-3">Abmelden</a>
        </div>
    </div>

    <!-- ‚ö° SOFORT-AKTIONEN MITTIG -->
    <div class="action-header text-center">
        <h5 class="text-white fw-bold mb-4" style="letter-spacing: 0.05em;"><i class="bi bi-lightning-charge-fill text-warning me-2"></i> SOFORT-AKTIONEN</h5>
        <div class="d-flex gap-3 justify-content-center flex-wrap">
            <form action="/quiz/send-random" method="POST" class="m-0">
                <button type="submit" class="btn btn-primary fw-bold px-5 py-2" style="border-radius: 12px; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2); font-size: 0.85rem;">
                    ‚ùî QUIZFRAGE SENDEN
                </button>
            </form>
            <form action="/umfrage/send-random" method="POST" class="m-0">
                <button type="submit" class="btn btn-secondary fw-bold px-5 py-2" style="border-radius: 12px; background-color: #475569; border: none; font-size: 0.85rem;">
                    üìä UMFRAGE SENDEN
                </button>
            </form>
        </div>
    </div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        <!-- Live Moderation -->
        <div class="col">
            <div class="card">
                <div class="card-header"><h6><i class="bi bi-shield-check me-2"></i>Live Moderation</h6></div>
                <div class="card-body d-flex flex-column">
                    <p class="card-text small text-secondary mb-4">√úberwachen und moderieren Sie Telegram-Gruppen in Echtzeit.</p>
                    <div class="mt-auto">
                        <a href="{{ url_for('live_moderation') }}" class="btn-settings-big">√ñFFNEN</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- üì¢ Nachricht Planer -->
        <div class="col">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6>üì¢ Nachricht Planer</h6>
                    <span class="small fw-bold {{ 'text-success' if bot_status.id_finder.running else 'text-danger' }}">
                        <span class="status-badge {{ 'bg-success' if bot_status.id_finder.running else 'bg-danger' }}"></span>
                        {{ 'AKTIV' if bot_status.id_finder.running else 'OFFLINE' }}
                    </span>
                </div>
                <div class="card-body d-flex flex-column">
                    <p class="card-text small text-secondary mb-4">Nachrichten & Medien planen oder sofort √ºber den ID-Finder senden.</p>
                    <div class="mt-auto">
                        <a href="{{ url_for('broadcast_manager') }}" class="btn-settings-big">EINSTELLUNGEN</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- üëã Einladungs-Bot -->
        <div class="col">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6>üëã Einladungs-Bot</h6>
                    <span class="small fw-bold {{ 'text-success' if bot_status.invite.running else 'text-danger' }}">
                        <span class="status-badge {{ 'bg-success' if bot_status.invite.running else 'bg-danger' }}"></span>
                        {{ 'AKTIV' if bot_status.invite.running else 'OFFLINE' }}
                    </span>
                </div>
                <div class="card-body d-flex flex-column">
                    <p class="card-text small text-secondary mb-4">Begr√º√üungstexte & automatische Beitrittskontrolle.</p>
                    <div class="mt-auto">
                        <div class="d-flex gap-2 mb-2">
                            {% if bot_status.invite.running %}
                                <form action="/bot-action/invite/stop" method="POST" class="flex-grow-1 m-0"><button type="submit" class="btn btn-danger btn-action-sm w-100">STOP</button></form>
                            {% else %}
                                <form action="/bot-action/invite/start" method="POST" class="flex-grow-1 m-0"><button type="submit" class="btn btn-success btn-action-sm w-100">START</button></form>
                            {% endif %}
                        </div>
                        <a href="{{ url_for('bot_settings') }}" class="btn-settings-big">EINSTELLUNGEN</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚ùî Quiz Bot -->
        <div class="col">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6>‚ùî Quiz Bot</h6>
                    <span class="small fw-bold {{ 'text-success' if bot_status.quiz.running else 'text-danger' }}">
                        <span class="status-badge {{ 'bg-success' if bot_status.quiz.running else 'bg-danger' }}"></span>
                        {{ 'AKTIV' if bot_status.quiz.running else 'OFFLINE' }}
                    </span>
                </div>
                <div class="card-body d-flex flex-column">
                    <p class="card-text small text-secondary mb-4">Verwaltung der Quizfragen und automatischer Zeitplaner.</p>
                    <div class="mt-auto">
                        <div class="d-flex gap-2 mb-2">
                            {% if bot_status.quiz.running %}
                                <form action="/bot-action/quiz/stop" method="POST" class="flex-grow-1 m-0"><button type="submit" class="btn btn-danger btn-action-sm w-100">STOP</button></form>
                            {% else %}
                                <form action="/bot-action/quiz/start" method="POST" class="flex-grow-1 m-0"><button type="submit" class="btn btn-success btn-action-sm w-100">START</button></form>
                            {% endif %}
                        </div>
                        <a href="{{ url_for('quiz_settings') }}" class="btn-settings-big">EINSTELLUNGEN</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- üìä Umfrage Bot -->
        <div class="col">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6>üìä Umfrage Bot</h6>
                    <span class="small fw-bold {{ 'text-success' if bot_status.umfrage.running else 'text-danger' }}">
                        <span class="status-badge {{ 'bg-success' if bot_status.umfrage.running else 'bg-danger' }}"></span>
                        {{ 'AKTIV' if bot_status.umfrage.running else 'OFFLINE' }}
                    </span>
                </div>
                <div class="card-body d-flex flex-column">
                    <p class="card-text small text-secondary mb-4">Verwaltung der Umfragen und automatischer Zeitplaner.</p>
                    <div class="mt-auto">
                        <div class="d-flex gap-2 mb-2">
                            {% if bot_status.umfrage.running %}
                                <form action="/bot-action/umfrage/stop" method="POST" class="flex-grow-1 m-0"><button type="submit" class="btn btn-danger btn-action-sm w-100">STOP</button></form>
                            {% else %}
                                <form action="/bot-action/umfrage/start" method="POST" class="flex-grow-1 m-0"><button type="submit" class="btn btn-success btn-action-sm w-100">START</button></form>
                            {% endif %}
                        </div>
                        <a href="{{ url_for('umfrage_settings') }}" class="btn-settings-big">EINSTELLUNGEN</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- üëó Outfit-Wettbewerb -->
        <div class="col">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6>üëó Outfit-Wettbewerb</h6>
                    <span class="small fw-bold {{ 'text-success' if bot_status.outfit.running else 'text-danger' }}">
                        <span class="status-badge {{ 'bg-success' if bot_status.outfit.running else 'bg-danger' }}"></span>
                        {{ 'AKTIV' if bot_status.outfit.running else 'OFFLINE' }}
                    </span>
                </div>
                <div class="card-body d-flex flex-column">
                    <p class="card-text small text-secondary mb-4">Steuerung f√ºr den t√§glichen Outfit-Contest.</p>
                    <div class="mt-auto">
                        <div class="d-flex gap-2 mb-2">
                            {% if bot_status.outfit.running %}
                                <form action="/bot-action/outfit/stop" method="POST" class="flex-grow-1 m-0"><button type="submit" class="btn btn-danger btn-action-sm w-100">STOP</button></form>
                            {% else %}
                                <form action="/bot-action/outfit/start" method="POST" class="flex-grow-1 m-0"><button type="submit" class="btn btn-success btn-action-sm w-100">START</button></form>
                            {% endif %}
                        </div>
                        <a href="{{ url_for('outfit_bot_dashboard') }}" class="btn-settings-big">EINSTELLUNGEN</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- üîç ID-Finder Bot -->
        <div class="col">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6>üîç ID-Finder Bot</h6>
                    <span class="small fw-bold {{ 'text-success' if bot_status.id_finder.running else 'text-danger' }}">
                        <span class="status-badge {{ 'bg-success' if bot_status.id_finder.running else 'bg-danger' }}"></span>
                        {{ 'AKTIV' if bot_status.id_finder.running else 'OFFLINE' }}
                    </span>
                </div>
                <div class="card-body d-flex flex-column">
                    <p class="card-text small text-secondary mb-4">Werkzeuge zum Ermitteln von Chat-IDs & Topic-IDs.</p>
                    <div class="mt-auto">
                        <div class="d-flex gap-2 mb-2">
                            {% if bot_status.id_finder.running %}
                                <form action="/bot-action/id_finder/stop" method="POST" class="flex-grow-1 m-0"><button type="submit" class="btn btn-danger btn-action-sm w-100">STOP</button></form>
                            {% else %}
                                <form action="/bot-action/id_finder/start" method="POST" class="flex-grow-1 m-0"><button type="submit" class="btn btn-success btn-action-sm w-100">START</button></form>
                            {% endif %}
                        </div>
                        <a href="{{ url_for('id_finder_dashboard') }}" class="btn-settings-big">EINSTELLUNGEN</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚õèÔ∏è Minecraft -->
        <div class="col">
            <div class="card">
                <div class="card-header"><h6>‚õèÔ∏è Minecraft Server Status</h6></div>
                <div class="card-body d-flex flex-column">
                    <p class="card-text small text-secondary mb-4">Status√ºberwachung und Benachrichtigungen.</p>
                    <div class="mt-auto">
                     <a href="/minecraft" class="btn-settings-big">EINSTELLUNGEN</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- üë• Benutzerverwaltung -->
        {% if session.get('role') == 'admin' %}
        <div class="col">
            <div class="card">
                <div class="card-header"><h6 class="text-info">üë• Benutzerverwaltung</h6></div>
                <div class="card-body d-flex flex-column">
                    <p class="card-text small text-secondary mb-4">Benutzerkonten & Zugriffsrechte verwalten.</p>
                    <div class="mt-auto">
                        <a href="{{ url_for('manage_users') }}" class="btn-settings-big">EINSTELLUNGEN</a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- ‚ö†Ô∏è Kritische Logs (Neu) -->
        {% if session.get('role') == 'admin' %}
        <div class="col">
            <div class="card">
                <div class="card-header"><h6 class="text-danger">‚ö†Ô∏è Kritische Logs</h6></div>
                <div class="card-body d-flex flex-column">
                    <p class="card-text small text-secondary mb-4">Zeigt alle Error- und Critical-Logs der Anwendung an.</p>
                    <div class="mt-auto">
                        <a href="{{ url_for('critical_errors') }}" class="btn-settings-big btn-danger">LOGS ANSEHEN</a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- üöÄ UPDATE CARD (Moved to bottom) -->
    <div id="updateSection" style="display: none;" class="mt-5 mb-5">
        <div class="card update-card shadow-lg">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="text-white fw-bold mb-1"><i class="bi bi-arrow-up-circle-fill text-primary me-2"></i> Update Verf√ºgbar!</h5>
                        <p class="small text-secondary mb-0">Eine neue Version deiner Bot-Software wurde ver√∂ffentlicht.</p>
                    </div>
                    <span class="badge bg-primary px-3 py-2" id="updateStatusBadge">UPDATE VERF√úGBAR</span>
                </div>

                <div class="row g-4 mb-3">
                    <div class="col-md-3">
                        <div class="p-3 bg-dark rounded-3 border border-secondary border-opacity-25">
                            <div class="text-secondary small mb-1">Deine Version</div>
                            <div class="fw-bold text-white"><span class="version-tag">{{ version.version }}</span></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 bg-dark rounded-3 border border-primary border-opacity-25">
                            <div class="text-secondary small mb-1">Neueste Version</div>
                            <div class="fw-bold text-white"><span class="version-tag" id="latestVersionText">-</span></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 bg-dark rounded-3 border border-secondary border-opacity-25">
                            <div class="text-secondary small mb-1">Ver√∂ffentlicht am</div>
                            <div class="fw-bold text-white" id="releaseDateText">-</div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h6 class="text-white small fw-bold mb-2">WAS IST NEU?</h6>
                    <div id="updateChangelog">L√§dt...</div>
                </div>

                <div id="updateActionArea">
                    <button id="btnStartUpdate" class="btn btn-primary fw-bold w-100 py-3" style="border-radius: 12px; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);">
                        JETZT AKTUALISIEREN
                    </button>
                </div>

                <div id="updateProgressArea" style="display: none;">
                    <div class="d-flex justify-content-between mb-2 small text-white">
                        <span id="progressText">Installation wird vorbereitet...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress" style="height: 10px; background-color: #334155; border-radius: 5px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" style="width: 0%"></div>
                    </div>
                    <p class="text-warning small mt-3 text-center mb-0">
                        <i class="bi bi-exclamation-triangle-fill me-1"></i> 
                        Bitte die Seite nicht schlie√üen. Die App startet nach dem Update automatisch neu.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let updateInfo = null;

    async function checkUpdate() {
        try {
            const resp = await fetch('/api/update/check');
            const data = await resp.json();
            
            if (data.update_available) {
                updateInfo = data;
                document.getElementById('updateSection').style.display = 'block';
                document.getElementById('latestVersionText').innerText = 'v' + data.latest_version;
                document.getElementById('releaseDateText').innerText = new Date(data.published_at).toLocaleString('de-DE');
                document.getElementById('updateChangelog').innerText = data.changelog || 'Keine Beschreibung verf√ºgbar.';
            }
        } catch (e) {
            console.error("Update-Check fehlgeschlagen", e);
        }
    }

    document.getElementById('btnStartUpdate').onclick = async () => {
        if (!updateInfo) return;
        
        if (!confirm("Bist du sicher, dass du das Update jetzt installieren m√∂chtest? Die App wird dabei neu gestartet.")) return;

        document.getElementById('updateActionArea').style.display = 'none';
        document.getElementById('updateProgressArea').style.display = 'block';

        const resp = await fetch('/api/update/install', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(updateInfo)
        });

        if (resp.ok) {
            pollUpdateStatus();
        } else {
            alert("Fehler beim Starten des Updates.");
            location.reload();
        }
    };

    async function pollUpdateStatus() {
        const interval = setInterval(async () => {
            const resp = await fetch('/api/update/status');
            const data = await resp.json();

            document.getElementById('progressBar').style.width = data.progress + '%';
            document.getElementById('progressPercent').innerText = data.progress + '%';
            
            if (data.status === 'downloading') document.getElementById('progressText').innerText = 'Lade Dateien von GitHub herunter...';
            if (data.status === 'extracting') document.getElementById('progressText').innerText = 'Entpacke Firmware-Paket...';
            if (data.status === 'applying') document.getElementById('progressText').innerText = 'Dateien werden ersetzt...';
            if (data.status === 'finished') {
                document.getElementById('progressText').innerText = 'Update erfolgreich! App startet neu...';
                clearInterval(interval);
                setTimeout(() => {
                    checkAppBackOnline();
                }, 5000);
            }
            if (data.status === 'error') {
                document.getElementById('progressText').innerText = 'Fehler: ' + data.error;
                document.getElementById('progressBar').classList.add('bg-danger');
                clearInterval(interval);
            }
        }, 1000);
    }

    async function checkAppBackOnline() {
        document.getElementById('progressText').innerText = 'Warte auf Neustart...';
        const timer = setInterval(async () => {
            try {
                const resp = await fetch('/');
                if (resp.ok) {
                    clearInterval(timer);
                    location.reload();
                }
            } catch (e) {}
        }, 2000);
    }

    // Beim Laden pr√ºfen
    checkUpdate();
</script>
{% endblock %}
