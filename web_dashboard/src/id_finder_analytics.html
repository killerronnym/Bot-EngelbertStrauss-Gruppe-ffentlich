{% extends "base.html" %}

{% block title %}ID-Finder Analyse | Dashboard{% endblock %}

{% block content %}
<style>
    .dashboard-container { padding: 2.5rem; }
    .btn-back { background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border-muted); color: var(--text-secondary); font-weight: 500; border-radius: 8px; padding: 0.6rem 1.25rem; transition: all 0.2s ease; text-decoration: none; display: inline-flex; align-items: center; gap: 0.6rem; font-size: 0.85rem; }
    .btn-back:hover { background: rgba(255, 255, 255, 0.05); color: #fff; border-color: var(--blue-accent); }
    .card { background: var(--card-base); border: 1px solid var(--border-muted); border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }
    .card-header { background: rgba(0, 0, 0, 0.1); border-bottom: 1px solid var(--border-muted); padding: 1rem 1.5rem; }
    .card-header h6 { margin-bottom: 0; font-weight: 600; font-size: 0.8rem; letter-spacing: 0.05em; color: var(--text-secondary); text-transform: uppercase; }
    .stat-card { background: rgba(255, 255, 255, 0.01); border: 1px solid rgba(255, 255, 255, 0.05); padding: 1.25rem; border-radius: 10px; height: 100%; }
    .stat-label { font-size: 0.7rem; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem; }
    .stat-value { font-size: 1.3rem; font-weight: 800; color: var(--text-primary); }
    .table { color: var(--text-primary); --bs-table-bg: transparent; --bs-table-border-color: rgba(255, 255, 255, 0.04); font-size: 0.85rem; }
    .table thead th { background: rgba(0, 0, 0, 0.15); color: var(--text-dim); font-weight: 600; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.08em; padding: 0.8rem 1.2rem; border-bottom: 1px solid var(--border-muted); }
    .chart-container { position: relative; height: 350px; width: 100%; }
    .text-dim { color: var(--text-dim); }
    .text-blue { color: var(--blue-accent); }
    
    .leaderboard-row { cursor: pointer; transition: background 0.2s; }
    .leaderboard-row:hover { background: rgba(255, 255, 255, 0.03) !important; }
    .leaderboard-row.active { background: rgba(168, 85, 247, 0.1) !important; border-left: 3px solid #a855f7; }
    
    .ga-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #2d3748; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #a0aec0; }
    
    .user-pill { display: inline-flex; align-items: center; gap: 0.6rem; background: rgba(255, 255, 255, 0.03); padding: 0.4rem 1rem; border-radius: 8px; font-size: 0.85rem; border: 1px solid var(--border-muted); margin-bottom: 0.5rem; transition: all 0.2s; }
    .user-pill:hover { background: rgba(255, 255, 255, 0.05); }
    .user-pill .pill-count { font-weight: 800; opacity: 0.9; }
    .user-pill .bi-x-circle { cursor: pointer; opacity: 0.5; transition: opacity 0.2s; }
    .user-pill .bi-x-circle:hover { opacity: 1; color: #ef4444; }

    .filter-bar { background: rgba(0, 0, 0, 0.2); border: 1px solid var(--border-muted); border-radius: 10px; padding: 1rem; display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; }
</style>

<div class="dashboard-container">
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <a href="{{ url_for('id_finder_dashboard') }}" class="btn-back mb-4"><i class="bi bi-chevron-left"></i> ZURÜCK ZUR ÜBERSICHT</a>
            <h1 class="fw-bold mb-1 h3 text-white">ID-Finder <span class="text-blue">Analyse</span></h1>
            <p class="text-secondary small">Detaillierte Gruppenanalyse & User-Statistiken</p>
        </div>
        <div class="text-end">
            <span class="text-white fw-bold h4 mb-0">{{ stats.total_users }} gesp. User</span>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar mb-5">
        <div style="flex: 1; min-width: 120px;">
            <label class="small text-dim fw-bold mb-1">ZEITRAUM (TAGE)</label>
            <input id="gaDays" type="number" class="form-control" value="{{ request.args.get('days', '') }}" placeholder="Alle">
        </div>
        <div style="flex: 1; min-width: 150px;">
            <label class="small text-dim fw-bold mb-1">MONAT</label>
            <select id="gaMonth" class="form-select">
                <option value="0" {% if request.args.get('month', '0') == '0' %}selected{% endif %}>Alle Monate</option>
                <option value="1" {% if request.args.get('month') == '1' %}selected{% endif %}>Januar</option>
                <option value="2" {% if request.args.get('month') == '2' %}selected{% endif %}>Februar</option>
                <option value="3" {% if request.args.get('month') == '3' %}selected{% endif %}>März</option>
                <option value="4" {% if request.args.get('month') == '4' %}selected{% endif %}>April</option>
                <option value="5" {% if request.args.get('month') == '5' %}selected{% endif %}>Mai</option>
                <option value="6" {% if request.args.get('month') == '6' %}selected{% endif %}>Juni</option>
                <option value="7" {% if request.args.get('month') == '7' %}selected{% endif %}>Juli</option>
                <option value="8" {% if request.args.get('month') == '8' %}selected{% endif %}>August</option>
                <option value="9" {% if request.args.get('month') == '9' %}selected{% endif %}>September</option>
                <option value="10" {% if request.args.get('month') == '10' %}selected{% endif %}>Oktober</option>
                <option value="11" {% if request.args.get('month') == '11' %}selected{% endif %}>November</option>
                <option value="12" {% if request.args.get('month') == '12' %}selected{% endif %}>Dezember</option>
            </select>
        </div>
        <div style="flex: 1; min-width: 120px;">
            <label class="small text-dim fw-bold mb-1">JAHR</label>
            <select id="gaYear" class="form-select">
                <option value="0" {% if request.args.get('year', '0') == '0' %}selected{% endif %}>Alle Jahre</option>
                <option value="2024" {% if request.args.get('year') == '2024' %}selected{% endif %}>2024</option>
                <option value="2025" {% if request.args.get('year') == '2025' %}selected{% endif %}>2025</option>
                <option value="2026" {% if request.args.get('year') == '2026' %}selected{% endif %}>2026</option>
            </select>
        </div>
        <button id="gaLoadBtn" class="btn btn-blue-action px-4 fw-bold">DATEN LADEN</button>
    </div>

    <!-- Charts & Leaderboard Section -->
    <div class="row g-4 mb-5">
        <div class="col-lg-7">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h6>Aktivitäts-Zeitstrahl</h6>
                        <p class="small text-dim mb-0">Nachrichtenverlauf im Zeitraum.</p>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearComparison()">Chart zurücksetzen</button>
                </div>
                <div class="card-body">
                    <div id="activeUserPills" class="d-flex flex-wrap gap-2 mb-4">
                        <!-- User Pills go here -->
                    </div>
                    <div class="chart-container"><canvas id="gaTimelineCanvas"></canvas></div>
                </div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="card h-100">
                <div class="card-header">
                    <h6>Benutzer-Rangliste</h6>
                    <p class="small text-dim mb-0">Top-Benutzer (klickbar).</p>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 450px;">
                        <table class="table table-dark table-hover mb-0">
                            <thead class="sticky-top">
                                <tr>
                                    <th class="ps-4">Rang</th>
                                    <th>Benutzer</th>
                                    <th class="text-end">Nachrichten</th>
                                    <th class="text-end">Medien</th>
                                    <th class="text-end pe-4">Reaktionen</th>
                                </tr>
                            </thead>
                            <tbody id="gaLeaderboardBody">
                                {% for u in activity.leaderboard %}
                                <tr class="leaderboard-row" data-uid="{{ u.uid }}" data-msgs="{{ u.msgs }}" onclick="toggleUserComparison('{{ u.uid }}', '{{ u.name }}', {{ u.msgs }})">
                                    <td class="ps-4 text-dim">#{{ loop.index }}</td>
                                    <td>
                                        <div class="d-flex align-items-center gap-3">
                                            <img src="/tg/avatar/{{ u.uid }}" class="ga-avatar" onerror="this.src='https://ui-avatars.com/api/?name={{ u.name }}&background=random&color=fff'">
                                            <div>
                                                <div class="fw-bold text-white text-truncate" style="max-width: 120px;">{{ u.name }}</div>
                                                <div class="small text-dim">@{{ u.uid }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-end fw-bold">{{ u.msgs }}</td>
                                    <td class="text-end text-dim">{{ u.media }}</td>
                                    <td class="text-end text-blue pe-4">{{ u.reacts }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rest of the Analytics Content -->
    <div class="row g-4 mb-5">
        <div class="col-lg-6">
            <div class="card"><div class="card-header"><h6>Häufigste Uhrzeiten</h6></div><div class="card-body"><div class="chart-container" style="height: 250px;"><canvas id="gaHoursCanvas"></canvas></div></div></div>
        </div>
        <div class="col-lg-6">
            <div class="card"><div class="card-header"><h6>Häufigste Wochentage</h6></div><div class="card-body"><div class="chart-container" style="height: 250px;"><canvas id="gaWeekdaysCanvas"></canvas></div></div></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let timelineChart;
    const timelineLabels = {{ activity.timeline.labels|tojson }};
    const totalData = {{ activity.timeline.total|tojson }};
    const activeUsers = new Map();

    const colorPalette = ['#a855f7', '#ec4899', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#06b6d4', '#8b5cf6', '#6366f1', '#14b8a6'];

    function initCharts() {
        const ctx = document.getElementById('gaTimelineCanvas').getContext('2d');
        timelineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timelineLabels,
                datasets: [{
                    label: 'Gesamt Nachrichten',
                    data: totalData,
                    borderColor: 'rgba(255, 255, 255, 0.15)',
                    backgroundColor: 'rgba(255, 255, 255, 0.05)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { display: true, position: 'top', align: 'end', labels: { color: '#64748b', boxWidth: 12, usePointStyle: true } } },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b' } },
                    x: { grid: { display: false }, ticks: { color: '#64748b', maxRotation: 0, autoSkip: true, maxTicksLimit: 12 } }
                }
            }
        });

        new Chart(document.getElementById('gaHoursCanvas'), {
            type: 'bar',
            data: {
                labels: Array.from({length: 24}, (_, i) => i + ':00'),
                datasets: [{ data: {{ activity.busiest_hours|tojson }}, backgroundColor: '#06b6d4', borderRadius: 4 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        new Chart(document.getElementById('gaWeekdaysCanvas'), {
            type: 'bar',
            data: {
                labels: ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'],
                datasets: [{ data: {{ activity.busiest_days|tojson }}, backgroundColor: '#a855f7', borderRadius: 4 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    async function toggleUserComparison(uid, name, msgs) {
        if (activeUsers.has(uid)) { removeUserFromComparison(uid); return; }
        if (activeUsers.size >= 10) { alert("Maximal 10 Benutzer gleichzeitig."); return; }
        const color = colorPalette[activeUsers.size % colorPalette.length];
        
        try {
            const days = document.getElementById("gaDays").value;
            const month = document.getElementById("gaMonth").value;
            const year = document.getElementById("gaYear").value;
            const res = await fetch(`/api/id-finder/user-activity/${uid}?days=${days}&month=${month}&year=${year}`);
            const userData = await res.json();
            
            timelineChart.data.datasets.push({
                label: `${name} / ${msgs}`,
                data: userData.timeline,
                borderColor: color,
                backgroundColor: color + '1A',
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 2,
                uid: uid
            });
            timelineChart.update();
            activeUsers.set(uid, { name, color, msgs });
            updateUserPills();
            const row = document.querySelector(`.leaderboard-row[data-uid="${uid}"]`);
            if (row) row.classList.add('active');
        } catch (e) { console.error(e); }
    }

    function removeUserFromComparison(uid) {
        activeUsers.delete(uid);
        timelineChart.data.datasets = timelineChart.data.datasets.filter(ds => ds.uid !== uid);
        timelineChart.update();
        updateUserPills();
        const row = document.querySelector(`.leaderboard-row[data-uid="${uid}"]`);
        if (row) row.classList.remove('active');
    }

    function clearComparison() {
        activeUsers.clear();
        timelineChart.data.datasets = [timelineChart.data.datasets[0]];
        timelineChart.update();
        updateUserPills();
        document.querySelectorAll('.leaderboard-row').forEach(r => r.classList.remove('active'));
    }

    function updateUserPills() {
        const container = document.getElementById('activeUserPills');
        container.innerHTML = '';
        activeUsers.forEach((data, uid) => {
            const pill = document.createElement('div');
            pill.className = 'user-pill';
            pill.style.borderColor = data.color;
            pill.style.color = data.color;
            pill.innerHTML = `<span>${data.name} <span class="pill-count">/ ${data.msgs}</span></span><i class="bi bi-x-circle ms-2" onclick="removeUserFromComparison('${uid}'); event.stopPropagation();"></i>`;
            container.appendChild(pill);
        });
    }

    document.getElementById("gaLoadBtn").addEventListener("click", () => {
        const days = document.getElementById("gaDays").value;
        const month = document.getElementById("gaMonth").value;
        const year = document.getElementById("gaYear").value;
        window.location.href = `{{ url_for('id_finder_analytics') }}?days=${days}&month=${month}&year=${year}`;
    });

    window.onload = initCharts;
</script>
{% endblock %}
