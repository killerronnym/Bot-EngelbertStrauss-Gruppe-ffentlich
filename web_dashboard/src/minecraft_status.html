{% extends "base.html" %}

{% block title %}Minecraft Server Status{% endblock %}

{% block content %}
<div class="container mt-4">
  <a href="/" class="btn btn-secondary mb-3">‚Üê Zur√ºck zum Haupt-Dashboard</a>

  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
    <h1 class="display-6 mb-0">‚õèÔ∏è Minecraft Server Status</h1>

    <div class="d-flex align-items-center gap-2 flex-wrap">
      <a class="btn btn-outline-primary" href="/minecraft">üîÑ Refresh</a>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Live-Infos -->
  <div class="card mt-3">
    <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div>üìä Aktueller Status</div>
      <small class="text-muted">Latenz: {{ latency_ms|default('‚Äî') }} ms</small>
    </div>

    <div class="card-body">
      {% set host_show = (cfg.display_host or cfg.mc_host or cfg.host or '‚Äî') %}
      {% set port_show = (cfg.display_port or cfg.mc_port or cfg.port or '‚Äî') %}

      <div class="row g-3">
        <div class="col-md-6">
          <div class="p-3 border rounded">
            <div class="text-muted">Anzeige (Telegram)</div>
            <div class="fw-bold">{{ host_show }}:{{ port_show }}</div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="p-3 border rounded">
            <div class="text-muted">Interne Abfrage</div>
            <div class="fw-bold">{{ cfg.mc_host or cfg.host or '‚Äî' }}:{{ cfg.mc_port or cfg.port or '‚Äî' }}</div>
          </div>
        </div>
      </div>

      {% if motd %}
        <div class="mt-3 p-3 border rounded">
          <div class="text-muted">MOTD</div>
          <div class="fw-semibold">{{ motd }}</div>
        </div>
      {% endif %}

      {% if players_text %}
        <div class="mt-3 p-3 border rounded">
          <div class="text-muted">Spieler</div>
          <div class="fw-semibold">{{ players_text }}</div>
        </div>
      {% endif %}

      {% if error %}
        <div class="mt-3 p-3 border rounded border-danger">
          <div class="text-muted">Fehler (wenn offline)</div>
          <div class="fw-semibold">{{ error }}</div>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Config -->
  <div class="card mt-3">
    <div class="card-header">‚öôÔ∏è Einstellungen</div>
    <div class="card-body">
      <form method="post" action="/minecraft">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Interne Server-IP / Host (f√ºr Abfrage)</label>
            <input class="form-control" name="mc_host" value="{{ (cfg.mc_host or cfg.host or '') }}" placeholder="z.B. 10.0.0.141" required>
            <div class="form-text">Damit verbindet sich mcstatus (lokal im Netzwerk).</div>
          </div>

          <div class="col-md-3">
            <label class="form-label">Interner Port</label>
            <input class="form-control" name="mc_port" value="{{ (cfg.mc_port or cfg.port or 25565) }}" type="number" min="1" max="65535" required>
          </div>

          <div class="col-md-6">
            <label class="form-label">Anzeige Host (DuckDNS / Public)</label>
            <input class="form-control" name="display_host" value="{{ (cfg.display_host or '') }}" placeholder="z.B. es-workwear-mc.duckdns.org">
          </div>

          <div class="col-md-3">
            <label class="form-label">Anzeige Port</label>
            <input class="form-control" name="display_port" value="{{ (cfg.display_port or cfg.mc_port or cfg.port or 25565) }}" type="number" min="1" max="65535">
          </div>

          <div class="col-md-6">
            <label class="form-label">Telegram Gruppenchat ID</label>
            <input class="form-control" name="chat_id" value="{{ (cfg.chat_id|string if cfg.chat_id is not none else '') }}" placeholder="-100..." required>
          </div>

          <div class="col-md-6">
            <label class="form-label">Topic ID (Thema)</label>
            <input class="form-control" name="topic_id" value="{{ (cfg.topic_id|string if cfg.topic_id is not none else '') }}" placeholder="z.B. 14332">
            <div class="form-text">Leer lassen = normaler Chat (kein Topic).</div>
          </div>

          <div class="col-md-3">
            <label class="form-label">Update Intervall (Sek.)</label>
            <input class="form-control" name="update_seconds" value="{{ (cfg.update_seconds or 30) }}" type="number" min="5" max="3600" required>
          </div>

          <div class="col-md-3">
            <label class="form-label">/player Auto-Delete (Sek.)</label>
            <input class="form-control" name="delete_player_seconds" value="{{ (cfg.delete_player_seconds or 8) }}" type="number" min="0" max="600" required>
          </div>

          <div class="col-md-3">
            <label class="form-label">Status Message ID</label>
            <input class="form-control" name="status_message_id" value="{{ (cfg.status_message_id|string if cfg.status_message_id is not none else '') }}" placeholder="leer = neue Nachricht" readonly>
            <div class="form-text">Wird automatisch gesetzt, wenn neu gesendet wurde.</div>
          </div>
        </div>

        <div class="d-flex gap-2 mt-4">
          <button class="btn btn-primary" type="submit">üíæ Speichern</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Logs -->
  <div class="card mt-3 mb-4">
    <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div>üìú Logs</div>

      {% if log_paths %}
        <small class="text-muted">
          {% for p in log_paths %}
            {{ p }}{% if not loop.last %} | {% endif %}
          {% endfor %}
        </small>
      {% else %}
        <small class="text-muted">{{ log_path|default('‚Äî') }}</small>
      {% endif %}
    </div>

    <div class="card-body">
      <pre style="max-height: 420px; overflow: auto; white-space: pre-wrap; margin:0;">{{ log_tail|default("‚Äî") }}</pre>
    </div>
  </div>

</div>
{% endblock %}
